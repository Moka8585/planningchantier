<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta content="Planificateur pour techniciens" name="description"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Planificateur Techniciens</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            opacity: 0.9;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .filter-group input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-info {
            font-weight: 600;
            color: #495057;
        }

        .calendar-container {
            overflow-x: auto;
            padding: 20px;
        }

        .calendar-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .calendar-table th {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .calendar-table td {
            border: 1px solid #dee2e6;
            padding: 0;
            vertical-align: top;
            min-width: 150px;
        }

        .tech-info {
            background: #f8f9fa;
            padding: 15px;
            border-right: 2px solid #dee2e6;
            min-width: 200px;
            position: sticky;
            left: 0;
            z-index: 5;
            position: relative;
        }

        .tech-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tech-info:hover .tech-actions {
            opacity: 1;
        }

        .tech-btn {
            width: 25px;
            height: 25px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .tech-btn-edit {
            background: #28a745;
            color: white;
        }

        .tech-btn-edit:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .tech-btn-delete {
            background: #dc3545;
            color: white;
        }

        .tech-btn-delete:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .tech-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .tech-details {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        .day-cell {
            min-height: 120px;
            padding: 8px;
            background: white;
            position: relative;
        }

        .day-header {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            margin-bottom: 8px;
            text-align: center;
            padding: 4px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .chantier-item {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .chantier-item:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(23,162,184,0.3);
        }

        .chantier-hours {
            font-weight: 700;
            float: right;
        }

        .comment-area {
            margin-top: 5px;
            padding: 4px;
            background: #fff3cd;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
            font-size: 11px;
            min-height: 20px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }

        .chantier-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }

        .chantier-section h4 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .today {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
        }

        .weekend {
            background: #f8f9fa !important;
        }

        .calendar-table th.weekend {
            background: linear-gradient(135deg, #5a6268 0%, #40464d 100%) !important;
        }

        .calendar-table td.weekend {
            background: #e9ecef !important;
        }

        .calendar-table th.today {
            background: linear-gradient(135deg, #f0ad4e 0%, #ed9d22 100%) !important;
            color: #fff;
        }

        .calendar-table td.today {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .week-nav {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
  <div class="container">
    <!-- Modal pour la gestion des listes (services & p√¥les) -->
    <div id="manageListsModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeManageListsModal()">√ó</span>
          <h2>G√©rer les listes</h2>
          <div>
              <h3>Services</h3>
              <ul id="servicesList"></ul>
              <input type="text" id="newService" placeholder="Nouveau service">
              <button onclick="addService()">Ajouter</button>
          </div>
          <div>
              <h3>P√¥les</h3>
              <ul id="polesList"></ul>
              <input type="text" id="newPole" placeholder="Nouveau p√¥le">
              <button onclick="addPole()">Ajouter</button>
          </div>
      </div>
    </div>

    <!-- En-t√™te -->
    <div class="header">
      <button onclick="openManageListsModal()">G√©rer les listes</button>
      <h1>üìÖ Planificateur Techniciens</h1>
      <div class="filters">
          <div class="filter-group">
              <label>Nom/Pr√©nom</label>
              <input id="filterName" placeholder="Rechercher un technicien..." type="text"/>
          </div>
          <div class="filter-group">
              <label>P√¥le</label>
              <select id="filterPole">
                <option value="">Tous les p√¥les</option>
              </select>
          </div>
          <div class="filter-group">
              <label>Chantier</label>
              <input id="filterChantier" placeholder="Rechercher un chantier..." type="text"/>
          </div>
      </div>
    </div>

    <!-- Contr√¥les et Navigation -->
    <div class="controls">
      <button class="btn" onclick="addTechnician()">‚ûï Ajouter Technicien</button>
      <button class="btn btn-secondary" onclick="exportData">üìä Exporter Donn√©es</button>
      <button class="btn btn-secondary" onclick="importData">üì• Importer Donn√©es</button>
      <div class="week-nav">
          <button class="btn btn-secondary" onclick="changeWeek(-1)" id="prevPeriodBtn">‚Üê Semaine Pr√©c√©dente</button>
          <span class="week-info" id="weekInfo">Semaine 24 - 2025</span>
          <button class="btn btn-secondary" onclick="changeWeek(1)" id="nextPeriodBtn">Semaine Suivante ‚Üí</button>
          <button class="btn btn-secondary" onclick="toggleViewMode()" id="toggleViewBtn">Vue Mensuelle</button>
      </div>
    </div>

    <!-- Calendrier -->
    <div class="calendar-container">
      <table class="calendar-table" id="calendarTable">
        <thead>
          <tr id="calendarHeader">
            <th>Technicien</th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Technicien -->
  <div class="modal" id="techModal">
    <div class="modal-content">
      <span class="close" onclick="closeTechModal()">√ó</span>
      <h2 id="techModalTitle">Ajouter un Technicien</h2>
      <form id="techForm">
        <div class="form-row">
          <div class="form-group">
            <label>Nom *</label>
            <input id="techNom" required type="text"/>
          </div>
          <div class="form-group">
            <label>Pr√©nom *</label>
            <input id="techPrenom" required type="text"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Service</label>
            <select id="techService">
              <option value="">S√©lectionnez un service</option>
            </select>
          </div>
          <div class="form-group">
            <label>Num√©ro Portable</label>
            <input id="techPortable" type="tel"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>P√¥le</label>
            <select id="techPole">
              <option value="">S√©lectionnez un p√¥le</option>
            </select>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input id="techEmail" type="email"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>N¬∞ Immatriculation</label>
            <input id="techImmatriculation" type="text"/>
          </div>
          <div class="form-group">
            <label>Ville</label>
            <input id="techVille" type="text"/>
          </div>
        </div>
        <button class="btn" type="submit">üíæ Enregistrer</button>
      </form>
    </div>
  </div>

  <!-- Modal Journ√©e -->
  <div class="modal" id="dayModal">
    <div class="modal-content">
      <span class="close" onclick="closeDayModal()">√ó</span>
      <h2 id="dayModalTitle">Planification de la journ√©e</h2>
      <div class="form-group">
        <label>Commentaire du jour</label>
        <textarea id="dayComment" placeholder="Commentaire g√©n√©ral pour cette journ√©e..." rows="3"></textarea>
      </div>
      <div class="chantier-section">
        <h4>üèóÔ∏è Chantier 1</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Chantier</label>
            <input id="chantier1" type="text"/>
          </div>
          <div class="form-group">
            <label>P√¥le</label>
            <select id="pole1">
              <option value="">S√©lectionnez un p√¥le</option>
            </select>
          </div>
          <div class="form-group">
            <label>Heures</label>
            <input id="heures1" max="24" min="0" step="0.5" type="number"/>
          </div>
        </div>
        <!-- Nouveaux champs pour la duplication -->
        <div class="form-row" style="margin-top: 10px; align-items: flex-end;">
          <div class="form-group" style="flex: 2;">
            <label>Dupliquer jusqu'√† (jours ouvr√©s)</label>
            <input type="date" id="duplicateUntilDate"/>
          </div>
          <div class="form-group" style="flex: 1;">
            <button class="btn btn-secondary" type="button" onclick="confirmAndDuplicateChantier()">Dupliquer</button>
          </div>
        </div>
      </div>
      <div class="chantier-section">
        <h4>üèóÔ∏è Chantier 2</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Chantier</label>
            <input id="chantier2" type="text"/>
          </div>
          <div class="form-group">
            <label>P√¥le</label>
            <select id="pole2">
              <option value="">S√©lectionnez un p√¥le</option>
            </select>
          </div>
          <div class="form-group">
            <label>Heures</label>
            <input id="heures2" max="24" min="0" step="0.5" type="number"/>
          </div>
        </div>
      </div>
      <div class="chantier-section">
        <h4>üèóÔ∏è Chantier 3</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Chantier</label>
            <input id="chantier3" type="text"/>
          </div>
          <div class="form-group">
            <label>P√¥le</label>
            <select id="pole3">
              <option value="">S√©lectionnez un p√¥le</option>
            </select>
          </div>
          <div class="form-group">
            <label>Heures</label>
            <input id="heures3" max="24" min="0" step="0.5" type="number"/>
          </div>
        </div>
      </div>
      <button class="btn" onclick="saveDayData()" type="button">üíæ Enregistrer la Journ√©e</button>
    </div>
  </div>

  <script>
    let technicians = [];
    let currentWeekStart = new Date();
    let currentTechId = null;
    let currentDate = null;
    let availableServices = ["CVC", "ELEC", "GTC", "AUTOM"];
    let availablePoles = ["PRO GTX", "PRO PTX", "PRO MAINT"];
    let planningData = {};
    let currentViewMode = 'week'; // 'week' ou 'month'

    // Initialisation unique au DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      loadDataFromLocalStorage(); // Charger les donn√©es au d√©marrage
      setCurrentWeek();
      generateCalendar();
      setupFilters();
      populateServiceDropdown();
      populatePoleDropdownForTechModal();
      // populatePoleDropdown();  // Si besoin d'un dropdown sp√©cifique pour les p√¥les dans d'autres formulaires
    });

    function setCurrentWeek() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      currentWeekStart = new Date(today);
      currentWeekStart.setDate(today.getDate() + mondayOffset);
    }

    function loadSampleData() {
      technicians = [
        {
          id: 1,
          nom: 'Dupont',
          prenom: 'Jean',
          service: 'ELEC',
          portable: '06.12.34.56.78',
          email: 'jean.dupont@entreprise.fr'
        },
        {
          id: 2,
          nom: 'Martin',
          prenom: 'Sophie',
          service: 'CVC',
          portable: '06.98.76.54.32',
          email: 'sophie.martin@entreprise.fr'
        }
      ];
    }

    function generateCalendar() {
      const header = document.getElementById('calendarHeader');
      const body = document.getElementById('calendarBody');
      
      // R√©initialisation de l'en-t√™te et du corps
      header.innerHTML = '<th>Technicien</th>';
      body.innerHTML = '';

      const toggleViewBtn = document.getElementById('toggleViewBtn');
      const prevPeriodBtn = document.getElementById('prevPeriodBtn');
      const nextPeriodBtn = document.getElementById('nextPeriodBtn');

      if (currentViewMode === 'week') {
        toggleViewBtn.textContent = 'Vue Mensuelle';
        prevPeriodBtn.innerHTML = '‚Üê Semaine Pr√©c√©dente';
        nextPeriodBtn.innerHTML = 'Semaine Suivante ‚Üí';
        // G√©n√©ration de l'en-t√™te avec dates (vue semaine)
        for (let i = 0; i < 7; i++) {
          const date = new Date(currentWeekStart);
          date.setDate(currentWeekStart.getDate() + i);
          
          const th = document.createElement('th');
          const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
          const dayNum = date.getDate();
          const monthName = date.toLocaleDateString('fr-FR', { month: 'short' });
          th.innerHTML = `${dayName}<br>${dayNum} ${monthName}`;
          
          if (date.getDay() === 0 || date.getDay() === 6) {
            th.classList.add('weekend');
          }
          
          if (isToday(date)) {
            th.classList.add('today');
          }
          header.appendChild(th);
        }

        // Mise √† jour de l'information de semaine
        const weekNumber = getWeekNumber(currentWeekStart);
        document.getElementById('weekInfo').textContent =
            `Semaine ${weekNumber} - ${currentWeekStart.getFullYear()}`;

        // G√©n√©ration d'une ligne pour chaque technicien filtr√© (vue semaine)
        const filteredTechs = getFilteredTechnicians();
        filteredTechs.forEach(tech => {
          const row = document.createElement('tr');
          
          // Cellule d'information du technicien
          const techCell = document.createElement('td');
          techCell.className = 'tech-info';
          techCell.innerHTML = `
            <div class="tech-actions">
              <button class="tech-btn tech-btn-edit" onclick="event.stopPropagation(); editTechnician(${tech.id})" title="Modifier">‚úèÔ∏è</button>
              <button class="tech-btn tech-btn-delete" onclick="event.stopPropagation(); deleteTechnician(${tech.id})" title="Supprimer">üóëÔ∏è</button>
            </div>
            <div class="tech-name">${tech.prenom} ${tech.nom}</div>
            <div class="tech-details">
              Service: ${tech.service || 'N/A'}<br>
              P√¥le: ${tech.pole || 'N/A'}<br>
              üì± ${tech.portable || 'N/A'}<br>
              ‚úâÔ∏è ${tech.email || 'N/A'}<br>
              üöó ${tech.immatriculation || 'N/A'}<br>
              üèôÔ∏è ${tech.ville || 'N/A'}
            </div>
          `;
          row.appendChild(techCell);

          // Cellules pour chaque jour (vue semaine)
          for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(currentWeekStart.getDate() + i);
            
            const dayCell = document.createElement('td');
            dayCell.className = 'day-cell';
            dayCell.onclick = () => openDayModal(tech.id, date);
            
            if (date.getDay() === 0 || date.getDay() === 6) {
              dayCell.classList.add('weekend');
            }
            
            if (isToday(date)) {
              dayCell.classList.add('today');
            }

            const dateKey = `${tech.id}_${date.toISOString().split('T')[0]}`;
            const dayData = planningData[dateKey];

            let cellContent = `<div class="day-header">${date.getDate()}</div>`;
            
            if (dayData) {
              // Affichage des chantiers
              for (let j = 1; j <= 3; j++) {
                const chantier = dayData[`chantier${j}`];
                const pole = dayData[`pole${j}`];
                const heures = dayData[`heures${j}`];
                if (chantier && heures) {
                  cellContent += `
                    <div class="chantier-item">
                      ${chantier} (${pole || 'N/A'})
                      <span class="chantier-hours">${heures}h</span>
                    </div>
                  `;
                }
              }
              // Commentaire du jour
              if (dayData.comment) {
                cellContent += `<div class="comment-area">${dayData.comment}</div>`;
              }
            }
            dayCell.innerHTML = cellContent;
            row.appendChild(dayCell);
          }
          body.appendChild(row);
        });

        // Nouvelle ligne pour le total des heures
        const totalRow = document.createElement('tr');
        const totalLabelCell = document.createElement('td');
        totalLabelCell.className = 'tech-info';
        totalLabelCell.innerHTML = '<div class="tech-name">Total Heures</div>';
        totalRow.appendChild(totalLabelCell);

        for (let i = 0; i < 7; i++) {
          const date = new Date(currentWeekStart);
          date.setDate(currentWeekStart.getDate() + i);
          const totalHoursForDay = calculateTotalHoursForDay(date, filteredTechs);
          const totalHoursCell = document.createElement('td');
          totalHoursCell.className = 'day-cell';
          if (date.getDay() === 0 || date.getDay() === 6) {
            totalHoursCell.classList.add('weekend');
          }
          if (isToday(date)) {
            totalHoursCell.classList.add('today');
          }
          totalHoursCell.innerHTML = `<div class="day-header">${totalHoursForDay}h</div>`;
          totalRow.appendChild(totalHoursCell);
        }
        body.appendChild(totalRow);

      } else { // currentViewMode === 'month'
        toggleViewBtn.textContent = 'Vue Hebdomadaire';
        const year = currentWeekStart.getFullYear();
        const month = currentWeekStart.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const numDays = lastDayOfMonth.getDate();

        prevPeriodBtn.innerHTML = '‚Üê Mois Pr√©c√©dent';
        nextPeriodBtn.innerHTML = 'Mois Suivant ‚Üí';

        // G√©n√©ration de l'en-t√™te avec dates (vue mois)
        for (let i = 1; i <= numDays; i++) {
          const date = new Date(year, month, i);
          
          const th = document.createElement('th');
          const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
          const dayNum = date.getDate();
          th.innerHTML = `${dayName}<br>${dayNum}`;
          
          if (date.getDay() === 0 || date.getDay() === 6) {
            th.classList.add('weekend');
          }
          
          if (isToday(date)) {
            th.classList.add('today');
          }
          header.appendChild(th);
        }

        // Mise √† jour de l'information du mois
        document.getElementById('weekInfo').textContent =
            `${firstDayOfMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;

        // G√©n√©ration d'une ligne pour chaque technicien filtr√© (vue mois)
        const filteredTechs = getFilteredTechnicians();
        filteredTechs.forEach(tech => {
          const row = document.createElement('tr');
          
          // Cellule d'information du technicien
          const techCell = document.createElement('td');
          techCell.className = 'tech-info';
          techCell.innerHTML = `
            <div class="tech-actions">
              <button class="tech-btn tech-btn-edit" onclick="event.stopPropagation(); editTechnician(${tech.id})" title="Modifier">‚úèÔ∏è</button>
              <button class="tech-btn tech-btn-delete" onclick="event.stopPropagation(); deleteTechnician(${tech.id})" title="Supprimer">üóëÔ∏è</button>
            </div>
            <div class="tech-name">${tech.prenom} ${tech.nom}</div>
            <div class="tech-details">
              Service: ${tech.service || 'N/A'}<br>
              P√¥le: ${tech.pole || 'N/A'}<br>
              üì± ${tech.portable || 'N/A'}<br>
              ‚úâÔ∏è ${tech.email || 'N/A'}<br>
              üöó ${tech.immatriculation || 'N/A'}<br>
              üèôÔ∏è ${tech.ville || 'N/A'}
            </div>
          `;
          row.appendChild(techCell);

          // Cellules pour chaque jour du mois
          for (let i = 1; i <= numDays; i++) {
            const date = new Date(year, month, i);
            
            const dayCell = document.createElement('td');
            dayCell.className = 'day-cell';
            dayCell.onclick = () => openDayModal(tech.id, date);
            
            if (date.getDay() === 0 || date.getDay() === 6) {
              dayCell.classList.add('weekend');
            }
            
            if (isToday(date)) {
              dayCell.classList.add('today');
            }

            const dateKey = `${tech.id}_${date.toISOString().split('T')[0]}`;
            const dayData = planningData[dateKey];

            let cellContent = `<div class="day-header">${date.getDate()}</div>`;
            
            if (dayData) {
              // Affichage des chantiers
              for (let j = 1; j <= 3; j++) {
                const chantier = dayData[`chantier${j}`];
                const pole = dayData[`pole${j}`];
                const heures = dayData[`heures${j}`];
                if (chantier && heures) {
                  cellContent += `
                    <div class="chantier-item">
                      ${chantier} (${pole || 'N/A'})
                      <span class="chantier-hours">${heures}h</span>
                    </div>
                  `;
                }
              }
              // Commentaire du jour
              if (dayData.comment) {
                cellContent += `<div class="comment-area">${dayData.comment}</div>`;
              }
            }
            dayCell.innerHTML = cellContent;
            row.appendChild(dayCell);
          }
          body.appendChild(row);
        });

        // Nouvelle ligne pour le total des heures (vue mois)
        const totalRow = document.createElement('tr');
        const totalLabelCell = document.createElement('td');
        totalLabelCell.className = 'tech-info';
        totalLabelCell.innerHTML = '<div class="tech-name">Total Heures</div>';
        totalRow.appendChild(totalLabelCell);

        for (let i = 1; i <= numDays; i++) {
          const date = new Date(year, month, i);
          const totalHoursForDay = calculateTotalHoursForDay(date, filteredTechs);
          const totalHoursCell = document.createElement('td');
          totalHoursCell.className = 'day-cell';
          if (date.getDay() === 0 || date.getDay() === 6) {
            totalHoursCell.classList.add('weekend');
          }
          if (isToday(date)) {
            totalHoursCell.classList.add('today');
          }
          totalHoursCell.innerHTML = `<div class="day-header">${totalHoursForDay}h</div>`;
          totalRow.appendChild(totalHoursCell);
        }
        body.appendChild(totalRow);

      }
    }

    function getFilteredTechnicians() {
      const nameFilter = document.getElementById('filterName').value.toLowerCase();
      const poleFilter = document.getElementById('filterPole').value.toLowerCase();
      const chantierFilter = document.getElementById('filterChantier').value.toLowerCase();

      return technicians.filter(tech => {
        const nameMatch = !nameFilter ||
            tech.nom.toLowerCase().includes(nameFilter) ||
            tech.prenom.toLowerCase().includes(nameFilter);
        
        // Utilisation des p√¥les d√©finis dans availablePoles
        const poleMatch = !poleFilter ||
            (tech.pole && tech.pole.toLowerCase() === poleFilter);
        
        let chantierMatch = !chantierFilter;
        if (chantierFilter) {
          // V√©rifier si un chantier correspond dans les donn√©es de planification
          for (const key in planningData) {
            if (key.startsWith(`${tech.id}_`)) {
              const data = planningData[key];
              for (let i = 1; i <= 3; i++) {
                const chantier = data[`chantier${i}`];
                if (chantier && chantier.toLowerCase().includes(chantierFilter)) {
                  chantierMatch = true;
                  break;
                }
              }
            }
            if (chantierMatch) break;
          }
        }
        return nameMatch && poleMatch && chantierMatch;
      });
    }

    function setupFilters() {
      const filters = ['filterName', 'filterPole', 'filterChantier'];
      filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('input', generateCalendar);
      });

      // Remplissage du filtre "P√¥le" en utilisant la liste availablePoles
      const poleSelect = document.getElementById('filterPole');
      poleSelect.innerHTML = '<option value="">Tous les p√¥les</option>';
      availablePoles.forEach(pole => {
        const option = document.createElement('option');
        option.value = pole;
        option.textContent = pole;
        poleSelect.appendChild(option);
      });
    }

    function addTechnician() {
      currentTechId = null;
      document.getElementById('techModalTitle').textContent = 'Ajouter un Technicien';
      document.getElementById('techForm').reset();
      document.getElementById('techModal').style.display = 'block';
    }

    function editTechnician(techId) {
      const tech = technicians.find(t => t.id === techId);
      if (!tech) {
        alert('Technicien introuvable !');
        return;
      }
      
      currentTechId = techId;
      document.getElementById('techModalTitle').textContent = 'Modifier le Technicien';
      document.getElementById('techNom').value = tech.nom || '';
      document.getElementById('techPrenom').value = tech.prenom || '';
      document.getElementById('techService').value = tech.service || '';
      document.getElementById('techPortable').value = tech.portable || '';
      document.getElementById('techEmail').value = tech.email || '';
      document.getElementById('techImmatriculation').value = tech.immatriculation || '';
      document.getElementById('techVille').value = tech.ville || '';
      populateServiceDropdown();
      populatePoleDropdownForTechModal();
      document.getElementById('techPole').value = tech.pole || '';
      document.getElementById('techModal').style.display = 'block';
    }

    function deleteTechnician(techId) {
      const tech = technicians.find(t => t.id === techId);
      if (!tech) {
        alert('Technicien introuvable !');
        return;
      }
      
      const confirmMessage = `√ätes-vous s√ªr de vouloir supprimer ${tech.prenom} ${tech.nom} ?\n\nToutes les donn√©es de planification associ√©es seront √©galement supprim√©es.`;
      if (confirm(confirmMessage)) {
        technicians = technicians.filter(t => t.id !== techId);
        const keysToDelete = Object.keys(planningData).filter(key => key.startsWith(`${techId}_`));
        keysToDelete.forEach(key => {
          delete planningData[key];
        });
        saveDataToLocalStorage(); // Sauvegarder les donn√©es apr√®s suppression
        setupFilters();
        generateCalendar();
        alert(`${tech.prenom} ${tech.nom} a √©t√© supprim√© avec succ√®s.`);
      }
    }

    function closeTechModal() {
      document.getElementById('techModal').style.display = 'none';
    }

    function openDayModal(techId, date) {
      currentTechId = techId;
      currentDate = date;
      const tech = technicians.find(t => t.id === techId);
      const dateStr = date.toLocaleDateString('fr-FR');
      document.getElementById('dayModalTitle').textContent = `${tech.prenom} ${tech.nom} - ${dateStr}`;
      
      const dateKey = `${techId}_${date.toISOString().split('T')[0]}`;
      const dayData = planningData[dateKey] || {};
      
      document.getElementById('dayComment').value = dayData.comment || '';
      for (let i = 1; i <= 3; i++) {
        populatePoleDropdownForChantier(`pole${i}`);
        document.getElementById(`chantier${i}`).value = dayData[`chantier${i}`] || '';
        document.getElementById(`pole${i}`).value = dayData[`pole${i}`] || '';
        document.getElementById(`heures${i}`).value = dayData[`heures${i}`] || '';
      }
      document.getElementById('duplicateUntilDate').value = ''; // R√©initialiser le champ de duplication
      document.getElementById('dayModal').style.display = 'block';
    }

    function closeDayModal() {
      document.getElementById('dayModal').style.display = 'none';
    }

    function saveDayData() {
      if (!currentTechId || !currentDate) return;
      
      // V√©rification : s'assurer que les heures saisies restent dans une fourchette acceptable (0 √† 24 par chantier)
      for (let i = 1; i <= 3; i++) {
        const heuresInput = document.getElementById(`heures${i}`);
        if (heuresInput.value) {
          const heures = parseFloat(heuresInput.value);
          if (isNaN(heures) || heures < 0 || heures > 24) {
            alert(`La valeur des heures pour chantier ${i} doit √™tre comprise entre 0 et 24.`);
            return;
          }
        }
      }
      
      const dateKey = `${currentTechId}_${currentDate.toISOString().split('T')[0]}`;
      const dayData = {
        comment: document.getElementById('dayComment').value
      };
      for (let i = 1; i <= 3; i++) {
        dayData[`chantier${i}`] = document.getElementById(`chantier${i}`).value;
        dayData[`pole${i}`] = document.getElementById(`pole${i}`).value;
        dayData[`heures${i}`] = document.getElementById(`heures${i}`).value;
      }
      planningData[dateKey] = dayData;
      saveDataToLocalStorage(); // Sauvegarder les donn√©es apr√®s la sauvegarde du jour
      closeDayModal();
      generateCalendar();
    }

    function changeWeek(direction) {
      if (currentViewMode === 'week') {
        currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
      } else { // month view
        currentWeekStart.setMonth(currentWeekStart.getMonth() + direction);
      }
      generateCalendar();
    }

    function isToday(date) {
      const today = new Date();
      return date.toDateString() === today.toDateString();
    }

    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    function exportData() {
      const data = {
        technicians: technicians,
        planning: planningData,
        exportDate: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `planning_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Fonction d'import de donn√©es JSON
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = event => {
          try {
            const importedData = JSON.parse(event.target.result);
            if (importedData.technicians && importedData.planning) {
              technicians = importedData.technicians;
              planningData = importedData.planning;
              availableServices = importedData.availableServices || availableServices; // Garder les anciens si non pr√©sents
              availablePoles = importedData.availablePoles || availablePoles; // Garder les anciens si non pr√©sents
              saveDataToLocalStorage(); // Sauvegarder les donn√©es apr√®s l'import
              setupFilters();
              generateCalendar();
              alert('Import r√©ussi !');
            } else {
              alert("Le fichier n'est pas au bon format.");
            }
          } catch (error) {
            alert("Erreur lors de l'import : " + error);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Formulaire de technicien
    document.getElementById('techForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const techData = {
        nom: document.getElementById('techNom').value.trim(),
        prenom: document.getElementById('techPrenom').value.trim(),
        service: document.getElementById('techService').value.trim(),
        portable: document.getElementById('techPortable').value.trim(),
        email: document.getElementById('techEmail').value.trim(),
        immatriculation: document.getElementById('techImmatriculation').value.trim(),
        ville: document.getElementById('techVille').value.trim(),
        pole: document.getElementById('techPole').value.trim()
      };
      if (!techData.nom || !techData.prenom) {
        alert('Le nom et le pr√©nom sont obligatoires !');
        return;
      }
      if (currentTechId) {
        const techIndex = technicians.findIndex(t => t.id === currentTechId);
        if (techIndex !== -1) {
          technicians[techIndex] = { ...technicians[techIndex], ...techData };
        }
      } else {
        const maxId = technicians.length > 0 ? Math.max(...technicians.map(t => t.id)) : 0;
        techData.id = maxId + 1;
        technicians.push(techData);
      }
      saveDataToLocalStorage(); // Sauvegarder les donn√©es apr√®s modification
      closeTechModal();
      setupFilters();
      generateCalendar();
    });

    // Fermeture des modals en cliquant hors de la modal
    window.onclick = function(event) {
      const techModal = document.getElementById('techModal');
      const dayModal = document.getElementById('dayModal');
      if (event.target === techModal) {
        techModal.style.display = 'none';
      }
      if (event.target === dayModal) {
        dayModal.style.display = 'none';
      }
    };

    function openManageListsModal() {
      document.getElementById('manageListsModal').style.display = 'block';
      updateListsDisplay();
    }

    function closeManageListsModal() {
      document.getElementById('manageListsModal').style.display = 'none';
    }

    function updateListsDisplay() {
      const servicesList = document.getElementById('servicesList');
      const polesList = document.getElementById('polesList');
      servicesList.innerHTML = availableServices.map(service => `<li>${service}</li>`).join('');
      polesList.innerHTML = availablePoles.map(pole => `<li>${pole}</li>`).join('');
    }

    function addService() {
      const newServiceInput = document.getElementById('newService');
      const newService = newServiceInput.value.trim();
      if (newService && !availableServices.includes(newService)) {
        availableServices.push(newService);
        newServiceInput.value = '';
        updateListsDisplay();
        populateServiceDropdown();
        saveDataToLocalStorage(); // Sauvegarder les donn√©es apr√®s modification
      }
    }

    function addPole() {
      const newPoleInput = document.getElementById('newPole');
      const newPole = newPoleInput.value.trim();
      if (newPole && !availablePoles.includes(newPole)) {
        availablePoles.push(newPole);
        newPoleInput.value = '';
        updateListsDisplay();
        setupFilters();
        saveDataToLocalStorage(); // Sauvegarder les donn√©es apr√®s modification
      }
    }

    function populateServiceDropdown() {
      const techServiceDropdown = document.getElementById('techService');
      techServiceDropdown.innerHTML = '<option value="">S√©lectionnez un service</option>' +
          availableServices.map(service => `<option value="${service}">${service}</option>`).join('');
    }

    function populatePoleDropdownForTechModal() {
      const techPoleDropdown = document.getElementById('techPole');
      techPoleDropdown.innerHTML = '<option value="">S√©lectionnez un p√¥le</option>' +
          availablePoles.map(pole => `<option value="${pole}">${pole}</option>`).join('');
    }

    function populatePoleDropdownForChantier(elementId) {
      const poleDropdown = document.getElementById(elementId);
      poleDropdown.innerHTML = '<option value="">S√©lectionnez un p√¥le</option>' +
          availablePoles.map(pole => `<option value="${pole}">${pole}</option>`).join('');
    }

    function toggleViewMode() {
      currentViewMode = currentViewMode === 'week' ? 'month' : 'week';
      generateCalendar();
    }

    function calculateTotalHoursForDay(date, filteredTechs) {
      let totalHours = 0;
      const dateStr = date.toISOString().split('T')[0];
      filteredTechs.forEach(tech => {
        const dateKey = `${tech.id}_${dateStr}`;
        const dayData = planningData[dateKey];
        if (dayData) {
          for (let j = 1; j <= 3; j++) {
            const heures = parseFloat(dayData[`heures${j}`]);
            if (!isNaN(heures)) {
              totalHours += heures;
            }
          }
        }
      });
      return totalHours.toFixed(1); // Arrondir √† une d√©cimale
    }

    function saveDataToLocalStorage() {
      localStorage.setItem('technicians', JSON.stringify(technicians));
      localStorage.setItem('planningData', JSON.stringify(planningData));
      localStorage.setItem('availableServices', JSON.stringify(availableServices));
      localStorage.setItem('availablePoles', JSON.stringify(availablePoles));
    }

    function loadDataFromLocalStorage() {
      const storedTechnicians = localStorage.getItem('technicians');
      const storedPlanningData = localStorage.getItem('planningData');
      const storedServices = localStorage.getItem('availableServices');
      const storedPoles = localStorage.getItem('availablePoles');

      if (storedTechnicians && storedPlanningData && storedServices && storedPoles) {
        technicians = JSON.parse(storedTechnicians);
        planningData = JSON.parse(storedPlanningData);
        availableServices = JSON.parse(storedServices);
        availablePoles = JSON.parse(storedPoles);
      } else {
        loadSampleData(); // Charger les donn√©es d'exemple si aucune donn√©e n'est stock√©e
      }
    }

    function confirmAndDuplicateChantier() {
      if (!currentTechId || !currentDate) {
        alert("Veuillez s√©lectionner un technicien et une date pour dupliquer.");
        return;
      }

      const duplicateUntilDate = document.getElementById('duplicateUntilDate').value;
      if (!duplicateUntilDate) {
        alert("Veuillez sp√©cifier une date jusqu'√† laquelle dupliquer.");
        return;
      }

      const confirmation = confirm("√ätes-vous s√ªr de vouloir dupliquer la saisie du chantier 1 pour les jours ouvr√©s jusqu'√† la date sp√©cifi√©e ? Cela √©crasera les saisies existantes.");
      if (confirmation) {
        duplicateChantier();
      }
    }

    function duplicateChantier() {
      const chantier1 = document.getElementById('chantier1').value;
      const pole1 = document.getElementById('pole1').value;
      const heures1 = parseFloat(document.getElementById('heures1').value);

      if (!chantier1 || isNaN(heures1) || heures1 <= 0) {
        alert("Veuillez saisir un chantier et des heures valides pour la duplication.");
        return;
      }

      const startDate = new Date(currentDate);
      startDate.setDate(startDate.getDate() + 1); // Commencer √† dupliquer √† partir du jour suivant
      const endDate = new Date(document.getElementById('duplicateUntilDate').value);

      let duplicatedCount = 0;

      for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
        const dayOfWeek = d.getDay(); // 0 = Dimanche, 1 = Lundi, ..., 6 = Samedi

        // Dupliquer uniquement les jours ouvr√©s (Lundi √† Vendredi)
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
          let hoursToApply = heures1;
          // R√®gle pour le vendredi : si heures > 8h, dupliquer 4h uniquement
          if (dayOfWeek === 5 && heures1 > 8) {
            hoursToApply = 4;
          }

          const dateKey = `${currentTechId}_${d.toISOString().split('T')[0]}`;
          const existingDayData = planningData[dateKey] || {};

          planningData[dateKey] = {
            ...existingDayData,
            chantier1: chantier1,
            pole1: pole1,
            heures1: hoursToApply.toFixed(1) // Sauvegarder avec une d√©cimale
          };
          duplicatedCount++;
        }
      }

      saveDataToLocalStorage();
      closeDayModal();
      generateCalendar();
      alert(`Duplication termin√©e. ${duplicatedCount} entr√©es ont √©t√© ajout√©es/mises √† jour.`);
    }
  </script>
</body>
</html>
